<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.empMapper">
    <!--회원가입-->
    <insert id="insertUser" parameterType="EmpDTO">
        INSERT INTO TB_EMPLOYEE ( EMP_NM
                                , EMP_PWD
                                , EMP_PHN
                                , EMP_EML
                                , EMP_ST_CD
                                , EMP_RNK_CD
                                , EMP_HR_DT
                                , EMP_BRT_DT
                                , IMG_NM
                                , REG_DTM)
        VALUES ( #{empNm}
               , #{empPwd}
               , #{empPhn}
               , #{empEml}
               , #{empStCd}
               , #{empRnkCd}
               , #{empHrDt}
               , #{empBrtDt}
               , #{imgNm}
               , sysdate())
    </insert>

    <!--    사원 목록 페이지-->
    <!--    사원 프로필 가져오기-->

    <select id="empList" resultType="EmpDTO" parameterType="java.lang.Integer">
        select EMP_NO     empno
             , EMP_NM     empNm
             , EMP_PHN    empPhn
             , EMP_EML    empEml
             , EMP_ST_CD  empStCd
             , EMP_RNK_CD empRnkCd
             , EMP_HR_DT  empHrDt
             , EMP_BRT_DT empBrtDt
             , REG_DTM
        from TB_EMPLOYEE LIMIT #{startList}, #{listSize}
    </select>

    <!--    페이징 데이터 가져오기-->
    <select id="getBoardListCnt" resultType="int">
        SELECT count(*) as listCnt
        FROM TB_EMPLOYEE
    </select>

    <!--    사원 프로필 업데이트-->
    <update id="empListUpdate" parameterType="EmpDTO">
        UPDATE TB_EMPLOYEE
        SET EMP_NM     = IFNULL(#{empNm}, EMP_NM),
            EMP_PWD    = IFNULL(#{empPwd}, EMP_PWD),
            EMP_PHN    = IFNULL(#{empPhn}, EMP_PHN),
            EMP_EML    = IFNULL(#{empEml}, EMP_EML),
            EMP_ST_CD  = IFNULL(#{empStCd}, EMP_ST_CD),
            EMP_RNK_CD = IFNULL(#{empRnkCd}, EMP_RNK_CD),
            EMP_HR_DT  = IFNULL(#{empHrDt}, EMP_HR_DT),
            EMP_BRT_DT = IFNULL(#{empBrtDt}, EMP_BRT_DT),
            EMP_SLR    = IFNULL(#{empSlr}, EMP_SLR)
        WHERE EMP_NO = #{empNo}
    </update>
    <!--로그인 구현-->
    <select id="selectLogin" resultType="EmpDTO" parameterType="LoginReq">
        SELECT EMP_NO     empNo
             , EMP_NM     empNm
             , EMP_PHN    empPhn
             , EMP_EML    empEml
             , EMP_ST_CD  empStCd
             , EMP_RNK_CD empRnkCd
             , EMP_HR_DT  empHrDt
             , EMP_BRT_DT empBrtDt
             , REG_DTM
        FROM TB_EMPLOYEE
        WHERE EMP_NM = #{empNm}
          AND EMP_PWD = #{empPwd}
    </select>
    <!--사원 프로필 검색-->
    <select id="selectBoardList" resultType="EmpDTO" parameterType="EmpReq">
        select EMP_NO empNo
        , EMP_NM empNm
        , EMP_PHN empPhn
        , EMP_EML empEml
        , EMP_ST_CD empStCd
        , EMP_RNK_CD empRnkCd
        , EMP_HR_DT empHrDt
        , EMP_BRT_DT empBrtDt
        , REG_DTM
        from TB_EMPLOYEE
        <include refid="sqlSelectBoardList"/>
        LIMIT #{startList}, #{listSize}
    </select>
    <!-- 검색 조건(이름,전화번호) -->
    <sql id="sqlSelectBoardList">
        <where>
            <if test="empNm != null and empNm != ''">
                and EMP_NM LIKE CONCAT('%', #{empNm}, '%')
            </if>
            <if test="empPhn != null and empPhn != ''">
                and EMP_PHN LIKE CONCAT('%', #{empPhn}, '%')
            </if>
        </where>
    </sql>

    <!--목록 갯수-->
    <select id="selectBoardListCnt" resultType="int" parameterType="EmpReq">
        select count(*)
        from TB_EMPLOYEE
        <include refid="sqlSelectBoardList"/>
    </select>

    <!--엑셀 download-->

    <select id="selectExcelList" resultType="EmpDTO" parameterType="java.lang.Integer">
        select EMP_NO  empno
             , EMP_NM  empNm
             , EMP_PHN empPhn
             , EMP_EML empEml
        from TB_EMPLOYEE
    </select>

    <!--엑셀 download-->
    <select id="selectEmpInfo" parameterType="int" resultType="EmpDTO">
        SELECT A.EMP_NO
             , A.EMP_NM
             , A.EMP_PHN
             , A.EMP_EML
             , D.IMG_NM
             , A.EMP_HR_DT
             , A.EMP_ACN_NMB
             , A.EMP_SLR
             , A.EMP_VCTN_TTL
             , A.EMP_BRT_DT
             , A.EMP_RNK_CD
             , A.EMP_ST_CD
             , A.EMP_AUTH_CD
             , B.CD_VAL_NM AS RNK_NM
             , C.CD_VAL_NM AS ST_NM
             , COALESCE(A.EMP_VCTN_TTL -
                        (SELECT SUM(VCTN_DAY_CNT) FROM TB_VACATION WHERE EMP_NO = A.EMP_NO AND VCTN_ST_CD = '02'), 0) AS VCTN_RSD_CNT
        FROM TB_EMPLOYEE A
                 LEFT JOIN TB_CODE B ON A.EMP_RNK_CD = B.CD_VAL AND B.CD_ID = 'EMP_RNK_CD'
                 LEFT JOIN TB_CODE C ON A.EMP_ST_CD = C.CD_VAL AND C.CD_ID = 'EMP_ST_CD'
                 LEFT JOIN TB_IMAGE D on A.IMG_NO = D.IMG_NO
        WHERE A.EMP_NO = #{empNo}
    </select>
</mapper>